# ACTIWELL BACKEND - HÆ¯á»šNG DáºªN SETUP VÃ€ CHáº Y Há»† THá»NG

## ðŸ“‹ BÆ¯á»šC 1: CHUáº¨N Bá»Š MÃ”I TRÆ¯á»œNG

### 1.1 Táº¡o cáº¥u trÃºc thÆ° má»¥c
```bash
# Táº¡o thÆ° má»¥c project
sudo mkdir -p /opt/actiwell
cd /opt/actiwell

# Táº¡o cÃ¡c thÆ° má»¥c con
sudo mkdir -p {templates,static,routes,logs,data}

# Táº¡o user cho á»©ng dá»¥ng
sudo useradd -r -s /bin/bash -d /opt/actiwell actiwell
sudo chown -R actiwell:actiwell /opt/actiwell
```

### 1.2 CÃ i Ä‘áº·t dependencies
```bash
# Cáº­p nháº­t system
sudo apt update && sudo apt upgrade -y

# CÃ i Ä‘áº·t Python vÃ  MySQL
sudo apt install -y python3 python3-pip python3-venv mysql-server

# CÃ i Ä‘áº·t USB vÃ  serial support
sudo apt install -y usbutils setserial
```

## ðŸ“ BÆ¯á»šC 2: Táº O CÃC FILE Cáº¦N THIáº¾T

### 2.1 File cáº¥u trÃºc
```
/opt/actiwell/
â”œâ”€â”€ app.py                    # Main Flask application
â”œâ”€â”€ config.py                 # Configuration
â”œâ”€â”€ models.py                 # Data models
â”œâ”€â”€ database_manager.py       # Database operations
â”œâ”€â”€ device_manager.py         # Device communication
â”œâ”€â”€ actiwell_api.py          # Actiwell API integration
â”œâ”€â”€ requirements.txt          # Python dependencies
â”œâ”€â”€ .env                     # Environment variables
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ device_routes.py
â”‚   â”œâ”€â”€ measurement_routes.py
â”‚   â””â”€â”€ sync_routes.py
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ dashboard.html
â”‚   â”œâ”€â”€ error.html
â”‚   â””â”€â”€ initializing.html
â”œâ”€â”€ static/                  # CSS, JS files
â”œâ”€â”€ logs/                    # Application logs
â””â”€â”€ data/                    # Raw measurement data
```

### 2.2 Táº¡o requirements.txt
```bash
cat > /opt/actiwell/requirements.txt << 'EOF'
Flask==2.3.3
Flask-CORS==4.0.0
mysql-connector-python==8.1.0
pyserial==3.5
requests==2.31.0
PyJWT==2.8.0
python-dotenv==1.0.0
psutil==5.9.5
EOF
```

### 2.3 Táº¡o .env configuration
```bash
cat > /opt/actiwell/.env << 'EOF'
# Database Configuration
DB_HOST=localhost
DB_USER=actiwell_user
DB_PASSWORD=actiwell_pass123
DB_NAME=actiwell_measurements
DB_POOL_SIZE=5

# Actiwell API Configuration (UPDATE THESE VALUES)
ACTIWELL_API_URL=https://api.actiwell.com
ACTIWELL_API_KEY=your_api_key_here
ACTIWELL_LOCATION_ID=1

# Application Configuration
SECRET_KEY=actiwell-secret-key-2024-change-this-in-production
JWT_EXPIRE_HOURS=24
WEB_PORT=5000
WEB_HOST=0.0.0.0
FLASK_DEBUG=False

# Device Configuration
TANITA_BAUDRATE=9600
INBODY_BAUDRATE=9600
DEVICE_TIMEOUT=5
AUTO_DETECT_DEVICES=True

# Storage Paths
DATA_STORAGE_PATH=/opt/actiwell/data
LOG_STORAGE_PATH=/opt/actiwell/logs
EOF
```

### 2.4 Copy source code files
**Copy táº¥t cáº£ source code tá»« cÃ¡c artifacts trÆ°á»›c vÃ o thÆ° má»¥c tÆ°Æ¡ng á»©ng:**

- `app.py` - Flask Application Core
- `config.py` - Configuration
- `models.py` - Data Models
- `database_manager.py` - Database Manager
- `device_manager.py` - Device Manager
- `actiwell_api.py` - Actiwell API Integration
- `routes/*.py` - API Routes

## ðŸ—„ï¸ BÆ¯á»šC 3: SETUP DATABASE

### 3.1 Cáº¥u hÃ¬nh MySQL
```bash
# Secure MySQL installation
sudo mysql_secure_installation

# Táº¡o database vÃ  user
sudo mysql -u root -p << 'EOF'
CREATE DATABASE actiwell_measurements CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'actiwell_user'@'localhost' IDENTIFIED BY 'actiwell_pass123';
GRANT ALL PRIVILEGES ON actiwell_measurements.* TO 'actiwell_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
EOF
```

### 3.2 Táº¡o database schema
```sql
-- Cháº¡y script nÃ y Ä‘á»ƒ táº¡o tables
USE actiwell_measurements;

-- Body measurements table
CREATE TABLE body_measurements (
    id INT AUTO_INCREMENT PRIMARY KEY,
    measurement_uuid VARCHAR(36) UNIQUE NOT NULL,
    device_id VARCHAR(50) NOT NULL,
    device_type VARCHAR(20) NOT NULL,
    customer_phone VARCHAR(20) NOT NULL,
    customer_id INT NULL,
    measurement_timestamp DATETIME NOT NULL,
    
    -- Basic measurements
    weight_kg DECIMAL(5,2) NULL,
    height_cm DECIMAL(5,2) NULL,
    bmi DECIMAL(5,2) NULL,
    
    -- Body composition
    body_fat_percent DECIMAL(5,2) NULL,
    muscle_mass_kg DECIMAL(5,2) NULL,
    bone_mass_kg DECIMAL(5,2) NULL,
    total_body_water_percent DECIMAL(5,2) NULL,
    protein_percent DECIMAL(5,2) NULL,
    mineral_percent DECIMAL(5,2) NULL,
    
    -- Advanced metrics
    visceral_fat_rating INT NULL,
    subcutaneous_fat_percent DECIMAL(5,2) NULL,
    skeletal_muscle_mass_kg DECIMAL(5,2) NULL,
    
    -- Metabolic data
    bmr_kcal INT NULL,
    metabolic_age INT NULL,
    
    -- Segmental analysis
    right_arm_muscle_kg DECIMAL(5,2) NULL,
    left_arm_muscle_kg DECIMAL(5,2) NULL,
    trunk_muscle_kg DECIMAL(5,2) NULL,
    right_leg_muscle_kg DECIMAL(5,2) NULL,
    left_leg_muscle_kg DECIMAL(5,2) NULL,
    
    -- Quality and sync
    measurement_quality VARCHAR(20) DEFAULT 'good',
    impedance_values TEXT NULL,
    synced_to_actiwell BOOLEAN DEFAULT FALSE,
    sync_attempts INT DEFAULT 0,
    last_sync_attempt DATETIME NULL,
    sync_error_message TEXT NULL,
    
    -- Raw data
    raw_data TEXT NULL,
    processing_notes TEXT NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_customer_phone (customer_phone),
    INDEX idx_device_id (device_id),
    INDEX idx_measurement_time (measurement_timestamp),
    INDEX idx_sync_status (synced_to_actiwell)
) ENGINE=InnoDB;

-- Device status table
CREATE TABLE device_status (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(50) UNIQUE NOT NULL,
    device_type VARCHAR(20) NOT NULL,
    serial_port VARCHAR(50) NOT NULL,
    connection_status VARCHAR(20) DEFAULT 'disconnected',
    firmware_version VARCHAR(50) NULL,
    last_heartbeat DATETIME NULL,
    last_measurement DATETIME NULL,
    total_measurements INT DEFAULT 0,
    error_count INT DEFAULT 0,
    configuration JSON NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- Customer mapping table
CREATE TABLE customer_mapping (
    id INT AUTO_INCREMENT PRIMARY KEY,
    phone_number VARCHAR(20) UNIQUE NOT NULL,
    actiwell_customer_id INT NOT NULL,
    customer_name VARCHAR(255) NULL,
    customer_email VARCHAR(255) NULL,
    last_updated DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_phone (phone_number),
    INDEX idx_actiwell_id (actiwell_customer_id)
) ENGINE=InnoDB;

-- Insert test data
INSERT INTO customer_mapping (phone_number, actiwell_customer_id, customer_name) VALUES 
('0901234567', 1, 'Test Customer 1'),
('0907654321', 2, 'Test Customer 2');
```

## ðŸ BÆ¯á»šC 4: SETUP PYTHON ENVIRONMENT

### 4.1 Táº¡o virtual environment
```bash
cd /opt/actiwell

# Táº¡o virtual environment
python3 -m venv venv

# Activate environment
source venv/bin/activate

# Upgrade pip
pip install --upgrade pip

# Install dependencies
pip install -r requirements.txt
```

### 4.2 Táº¡o __init__.py files
```bash
# Táº¡o __init__.py cho routes package
touch routes/__init__.py
```

## ðŸ”Œ BÆ¯á»šC 5: Cáº¤U HÃŒNH USB DEVICES

### 5.1 USB permissions
```bash
# Add user to dialout group
sudo usermod -a -G dialout actiwell

# Create udev rules
sudo tee /etc/udev/rules.d/99-actiwell-devices.rules << 'EOF'
# Tanita devices
SUBSYSTEM=="tty", ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6001", MODE="0666", GROUP="dialout"
SUBSYSTEM=="tty", ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6014", MODE="0666", GROUP="dialout"

# InBody devices  
SUBSYSTEM=="tty", ATTRS{interface}=="InBody*", MODE="0666", GROUP="dialout"

# Generic USB-to-Serial
SUBSYSTEM=="tty", ATTRS{idVendor}=="067b", ATTRS{idProduct}=="2303", MODE="0666", GROUP="dialout"
SUBSYSTEM=="tty", ATTRS{idVendor}=="10c4", ATTRS{idProduct}=="ea60", MODE="0666", GROUP="dialout"
EOF

# Reload udev rules
sudo udevadm control --reload-rules
sudo udevadm trigger
```

## ðŸš€ BÆ¯á»šC 6: CHáº Y Há»† THá»NG

### 6.1 Test run
```bash
cd /opt/actiwell
source venv/bin/activate

# Test database connection
python3 -c "
import mysql.connector
conn = mysql.connector.connect(
    host='localhost',
    user='actiwell_user', 
    password='actiwell_pass123',
    database='actiwell_measurements'
)
print('âœ“ Database connection OK')
conn.close()
"

# Test imports
python3 -c "
import flask
import mysql.connector
import serial
print('âœ“ All imports OK')
"

# Run application
python3 app.py
```

**Expected output:**
```
INFO - Initializing Database Manager...
INFO - Database Manager initialized successfully
INFO - Initializing Device Manager...
INFO - Device Manager initialized successfully
INFO - Initializing Actiwell API...
INFO - Actiwell API initialized successfully
INFO - All managers initialized successfully
INFO - Starting background services...
INFO - Measurement processor service started
INFO - Sync retry service started
INFO - Started 2 background services
INFO - Application startup completed successfully
INFO - Connected devices: 0
INFO - Server ready on 0.0.0.0:5000
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
 * Running on http://[your-ip]:5000
```

### 6.2 Táº¡o systemd service (Production)
```bash
# Táº¡o service file
sudo tee /etc/systemd/system/actiwell-backend.service << 'EOF'
[Unit]
Description=Actiwell Body Measurement Backend
After=network.target mysql.service
Wants=mysql.service

[Service]
Type=simple
User=actiwell
Group=actiwell
WorkingDirectory=/opt/actiwell
Environment=PATH=/opt/actiwell/venv/bin
ExecStart=/opt/actiwell/venv/bin/python app.py
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# Enable vÃ  start service
sudo systemctl daemon-reload
sudo systemctl enable actiwell-backend
sudo systemctl start actiwell-backend

# Check status
sudo systemctl status actiwell-backend
```

## ðŸŒ BÆ¯á»šC 7: TRUY Cáº¬P Há»† THá»NG

### 7.1 Web Dashboard
- **URL**: http://localhost:5000 hoáº·c http://[server-ip]:5000
- **Login**: 
  - Username: `admin`
  - Password: `actiwell123`

### 7.2 API Endpoints
```bash
# Health check
curl http://localhost:5000/api/health

# Login vÃ  get token
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"actiwell123"}'

# Get device status (with token)
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:5000/api/devices/status

# Get measurements
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:5000/api/measurements
```

## ðŸ”§ BÆ¯á»šC 8: Cáº¤U HÃŒNH ACTIWELL API

### 8.1 Cáº­p nháº­t .env file
```bash
# Edit .env file
nano /opt/actiwell/.env

# Update these values:
ACTIWELL_API_URL=https://your-actiwell-api-url.com
ACTIWELL_API_KEY=your-actual-api-key
ACTIWELL_LOCATION_ID=your-location-id
```

### 8.2 Restart service
```bash
sudo systemctl restart actiwell-backend
```

## ðŸ“Š BÆ¯á»šC 9: KIá»‚M TRA HOáº T Äá»˜NG

### 9.1 Utility scripts
```bash
# Táº¡o script kiá»ƒm tra tráº¡ng thÃ¡i
cat > /opt/actiwell/check_status.sh << 'EOF'
#!/bin/bash
echo "=== ACTIWELL BACKEND STATUS ==="
echo "Service Status:"
sudo systemctl status actiwell-backend --no-pager -l

echo -e "\nDevice Ports:"
ls -la /dev/ttyUSB* /dev/ttyACM* 2>/dev/null || echo "No USB devices found"

echo -e "\nDatabase Status:"
mysql -u actiwell_user -pactiwell_pass123 -e "SELECT COUNT(*) as total_measurements FROM actiwell_measurements.body_measurements;" 2>/dev/null || echo "Database connection failed"

echo -e "\nAPI Status:"
curl -s http://localhost:5000/api/health | python3 -m json.tool 2>/dev/null || echo "API not responding"

echo -e "\nLogs (last 10 lines):"
sudo journalctl -u actiwell-backend -n 10 --no-pager
EOF

chmod +x /opt/actiwell/check_status.sh

# Cháº¡y kiá»ƒm tra
/opt/actiwell/check_status.sh
```

### 9.2 Test vá»›i sample data
```bash
# Test measurement creation
curl -X POST http://localhost:5000/api/measurements \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "device_id": "test_device",
    "customer_phone": "0901234567",
    "weight_kg": 70.5,
    "body_fat_percent": 15.2,
    "muscle_mass_kg": 55.3
  }'
```

## ðŸš¨ TROUBLESHOOTING

### Common Issues:

1. **Database connection failed**
   ```bash
   # Check MySQL service
   sudo systemctl status mysql
   
   # Check credentials
   mysql -u actiwell_user -pactiwell_pass123 -e "SELECT 1;"
   ```

2. **Device not detected**
   ```bash
   # Check USB devices
   lsusb
   ls -la /dev/ttyUSB*
   
   # Check permissions
   groups actiwell
   ```

3. **Import errors**
   ```bash
   # Check virtual environment
   source /opt/actiwell/venv/bin/activate
   pip list
   
   # Reinstall if needed
   pip install -r requirements.txt
   ```

4. **Service won't start**
   ```bash
   # Check logs
   sudo journalctl -u actiwell-backend -f
   
   # Check file permissions
   sudo chown -R actiwell:actiwell /opt/actiwell
   ```

## ðŸŽ¯ NEXT STEPS

1. **Káº¿t ná»‘i thiáº¿t bá»‹ Tanita/InBody thá»±c táº¿**
2. **Cáº¥u hÃ¬nh Actiwell API credentials**
3. **Test measurement flow vá»›i thiáº¿t bá»‹ tháº­t**
4. **Setup monitoring vÃ  alerts**
5. **Backup vÃ  disaster recovery**

---

**ðŸŽ‰ ChÃºc má»«ng! Há»‡ thá»‘ng Actiwell Backend Ä‘Ã£ sáºµn sÃ ng hoáº¡t Ä‘á»™ng!**